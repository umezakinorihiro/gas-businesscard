<!doctype html>
<html>
  <body style="font-family: sans-serif;">
    <h3>名刺読み込み</h3>

    <input type="file" id="file" accept="image/*" />
    <div style="margin-top: 8px;">
      <button id="btn" disabled>読み込み</button>
    </div>

    <p id="status" style="margin-top: 12px;"></p>

    <script>
      const fileEl = document.getElementById("file");
      const btn = document.getElementById("btn");
      const statusEl = document.getElementById("status");
      let file = null;

      fileEl.addEventListener("change", () => {
        file = fileEl.files && fileEl.files[0];
        btn.disabled = !file;
        statusEl.textContent = "";
      });

      btn.addEventListener("click", () => {
        if (!file) return;

        statusEl.textContent = "送信中…";
        btn.disabled = true;

        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result;

          google.script.run
            .withSuccessHandler((r) => {
              statusEl.textContent = `完了！ ${r.rowIndex} 行目に追加しました。`;
              btn.disabled = false;
            })
            .withFailureHandler((err) => {
              statusEl.textContent = "エラー: " + (err && err.message ? err.message : err);
              btn.disabled = false;
            })
            .saveCardAndExtract(dataUrl, file.name, file.type);
        };
        reader.readAsDataURL(file);
      });
    </script>
  </body>
</html>